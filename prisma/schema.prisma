// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Opportunity {
  id              String    @id @default(cuid())
  name            String
  value           Float?
  company         String?
  referredBy      String?
  leadSourceType  String?
  contact         String?
  contactId       String?
  linkedContact   Contact?  @relation(fields: [contactId], references: [id])
  completedAt     DateTime?
  stage           String    @default("00 - Idées de contact")
  proposal        String?   @db.Text
  assignee        String?
  closedDate      DateTime?
  openDate        DateTime?
  region          String?
  segment         String?
  proposalSentDate DateTime?
  projectType     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([stage])
  @@index([region])
  @@index([segment])
  @@index([contactId])
}

model Contact {
  id                String    @id @default(cuid())
  fullName          String
  firstName         String?
  lastName          String?
  level             Int?
  potentialSale     Boolean   @default(false)
  photoUrl          String?
  linkedinUrl       String?
  position          String?
  company           String?
  email             String?
  phone             String?
  relation          String?
  circles           String?
  employmentField   String?
  lastUpdated       DateTime?
  region            String?
  birthday          String?
  link              String?
  tags              String?
  linkedOpportunities String?
  projects          String?
  language          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  opportunities     Opportunity[]

  @@index([region])
  @@index([employmentField])
  @@index([company])
}

model Project {
  id              String    @id @default(cuid())
  name            String
  client          String?
  team            String?
  status          String?
  stage           String?
  billing         String?
  lead            String?
  clientComm      String?
  contactName     String?
  contactMethod   String?
  hourlyRate      Float?
  proposalUrl     String?
  budget          String?
  driveUrl        String?
  asanaUrl        String?
  slackUrl        String?
  timeline        String?
  projectType     String?
  year            String?
  description     String?   @db.Text
  brief           String?   @db.Text
  testimonial     String?
  portfolio       String?
  report          String?
  communication   String?
  departments     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tasks           Task[]
  milestones      Milestone[]

  @@index([status])
  @@index([projectType])
  @@index([client])
  @@index([year])
}

model Company {
  id                String    @id @default(cuid())
  name              String
  logoUrl           String?
  website           String?
  address           String?
  phone             String?
  type              String?
  mainContactName   String?
  mainContactEmail  String?
  description       String?   @db.Text
  industry          String?
  insight           String?   @db.Text
  engagements       String?   @db.Text
  linkedinUrl       String?
  facebookUrl       String?
  instagramUrl      String?
  agencyPartners    String?
  referralPartners  String?
  isClient          Boolean   @default(false)
  testimonials      String?
  events            String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([type])
  @@index([industry])
  @@index([isClient])
}

// Departments: Lab, Bureau, Studio
model Employee {
  id            String    @id @default(cuid())
  name          String
  email         String?
  photoUrl      String?
  role          String?
  department    String    // Lab, Bureau, Studio
  currentTaskId String?   @unique // Only one current task per employee
  currentTask   Task?     @relation("CurrentTask", fields: [currentTaskId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([department])
}

// Task zones: current, shelf, storage, dock
// Task status: todo, in_progress, done
model Task {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  zone          String    @default("shelf") // current, shelf, storage, dock
  department    String    @default("Lab") // Lab, Bureau, Studio
  status        String    @default("todo") // todo, in_progress, done
  projectId     String?
  project       Project?  @relation(fields: [projectId], references: [id])
  priority      String?   @default("medium") // low, medium, high
  dueDate       DateTime?
  completedAt   DateTime?
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  assignedEmployee Employee? @relation("CurrentTask")

  @@index([zone])
  @@index([department])
  @@index([projectId])
  @@index([status])
}


// Events and Calendar
model Event {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  type          String    @default("meeting") // meeting, deadline, reminder, call, other
  startDate     DateTime
  endDate       DateTime?
  allDay        Boolean   @default(false)
  location      String?
  color         String?   @default("#6366f1")
  
  // Linked entities
  contactId     String?
  opportunityId String?
  projectId     String?
  companyId     String?
  
  // Reminders
  reminder      Boolean   @default(false)
  reminderTime  Int?      // minutes before event
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([startDate])
  @@index([type])
  @@index([contactId])
  @@index([opportunityId])
  @@index([projectId])
}

// Documents attachés aux entités
model Document {
  id            String    @id @default(cuid())
  name          String
  url           String
  type          String?   // pdf, doc, xls, image, etc.
  size          Int?      // taille en bytes
  
  // Entité liée (une seule à la fois)
  companyId     String?
  contactId     String?
  projectId     String?
  opportunityId String?
  
  uploadedBy    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([projectId])
  @@index([opportunityId])
}

// Historique des activités
model ActivityLog {
  id            String    @id @default(cuid())
  action        String    // created, updated, status_changed, note_added, document_uploaded, etc.
  description   String?
  entityType    String    // contact, company, project, opportunity
  entityId      String
  oldValue      String?   @db.Text
  newValue      String?   @db.Text
  userId        String?
  userName      String?
  createdAt     DateTime  @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

// Milestones (grandes tâches de projet)
model Milestone {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  status        String    @default("pending") // pending, in_progress, completed
  dueDate       DateTime?
  completedAt   DateTime?
  order         Int       @default(0)
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
}

// Notes et commentaires
model Note {
  id            String    @id @default(cuid())
  content       String    @db.Text
  entityType    String    // contact, company, project, opportunity
  entityId      String
  authorName    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([entityType, entityId])
}
