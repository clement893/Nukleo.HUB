// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Opportunity {
  id              String    @id @default(cuid())
  name            String
  value           Float?
  company         String?
  referredBy      String?
  leadSourceType  String?
  contact         String?
  contactId       String?
  linkedContact   Contact?  @relation(fields: [contactId], references: [id])
  completedAt     DateTime?
  stage           String    @default("00 - Idées de contact")
  proposal        String?   @db.Text
  assignee        String?
  closedDate      DateTime?
  openDate        DateTime?
  region          String?
  segment         String?
  proposalSentDate DateTime?
  projectType     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([stage])
  @@index([region])
  @@index([segment])
  @@index([contactId])
}

model Contact {
  id                String    @id @default(cuid())
  fullName          String
  firstName         String?
  lastName          String?
  level             Int?
  potentialSale     Boolean   @default(false)
  photoUrl          String?
  linkedinUrl       String?
  position          String?
  company           String?
  email             String?
  phone             String?
  relation          String?
  circles           String?
  employmentField   String?
  lastUpdated       DateTime?
  region            String?
  birthday          String?
  link              String?
  tags              String?
  linkedOpportunities String?
  projects          String?
  language          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  opportunities     Opportunity[]

  @@index([region])
  @@index([employmentField])
  @@index([company])
}

model Project {
  id              String    @id @default(cuid())
  name            String
  client          String?
  team            String?
  status          String?
  stage           String?
  billing         String?
  lead            String?
  clientComm      String?
  contactName     String?
  contactMethod   String?
  hourlyRate      Float?
  proposalUrl     String?
  budget          String?
  driveUrl        String?
  asanaUrl        String?
  slackUrl        String?
  timeline        String?
  projectType     String?
  year            String?
  description     String?   @db.Text
  brief           String?   @db.Text
  testimonial     String?
  portfolio       String?
  report          String?
  communication   String?
  departments     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tasks           Task[]
  milestones      Milestone[]

  @@index([status])
  @@index([projectType])
  @@index([client])
  @@index([year])
}

model Company {
  id                String    @id @default(cuid())
  name              String
  logoUrl           String?
  website           String?
  address           String?
  phone             String?
  type              String?
  mainContactName   String?
  mainContactEmail  String?
  description       String?   @db.Text
  industry          String?
  insight           String?   @db.Text
  engagements       String?   @db.Text
  linkedinUrl       String?
  facebookUrl       String?
  instagramUrl      String?
  agencyPartners    String?
  referralPartners  String?
  isClient          Boolean   @default(false)
  testimonials      String?
  events            String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([type])
  @@index([industry])
  @@index([isClient])
}

// Departments: Lab, Bureau, Studio
model Employee {
  id                    String    @id @default(cuid())
  name                  String
  email                 String?
  phone                 String?
  photoUrl              String?
  linkedinUrl           String?
  role                  String?
  department            String    // Lab, Bureau, Studio
  capacityHoursPerWeek  Int       @default(35) // Capacité en heures par semaine
  currentTaskId         String?   @unique // Only one current task per employee
  currentTask           Task?     @relation("CurrentTask", fields: [currentTaskId], references: [id])
  onboardingCompleted   Boolean   @default(false)
  onboardingStartedAt   DateTime?
  onboardingCompletedAt DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations onboarding
  onboardingProgress    OnboardingProgress[]
  policyAcknowledgments PolicyAcknowledgment[]
  chatMessages          ChatMessage[]

  @@index([department])
}

// Task zones: current, shelf, storage, dock
// Task status: todo, in_progress, done
model Task {
  id              String    @id @default(cuid())
  title           String
  description     String?   @db.Text
  zone            String    @default("shelf") // current, shelf, storage, dock
  department      String    @default("Lab") // Lab, Bureau, Studio
  status          String    @default("todo") // todo, in_progress, done
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  priority        String?   @default("medium") // low, medium, high
  estimatedHours  Float?    @default(2) // Heures estimées pour la tâche
  dueDate         DateTime?
  completedAt     DateTime?
  order           Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  assignedEmployee Employee? @relation("CurrentTask")

  @@index([zone])
  @@index([department])
  @@index([projectId])
  @@index([status])
}


// Events and Calendar
model Event {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  type          String    @default("meeting") // meeting, deadline, reminder, call, other
  startDate     DateTime
  endDate       DateTime?
  allDay        Boolean   @default(false)
  location      String?
  color         String?   @default("#6366f1")
  
  // Linked entities
  contactId     String?
  opportunityId String?
  projectId     String?
  companyId     String?
  
  // Reminders
  reminder      Boolean   @default(false)
  reminderTime  Int?      // minutes before event
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([startDate])
  @@index([type])
  @@index([contactId])
  @@index([opportunityId])
  @@index([projectId])
}

// Documents attachés aux entités
model Document {
  id            String    @id @default(cuid())
  name          String
  url           String
  type          String?   // pdf, doc, xls, image, etc.
  size          Int?      // taille en bytes
  
  // Entité liée (une seule à la fois)
  companyId     String?
  contactId     String?
  projectId     String?
  opportunityId String?
  
  uploadedBy    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([companyId])
  @@index([contactId])
  @@index([projectId])
  @@index([opportunityId])
}

// Historique des activités
model ActivityLog {
  id            String    @id @default(cuid())
  action        String    // created, updated, status_changed, note_added, document_uploaded, etc.
  description   String?
  entityType    String    // contact, company, project, opportunity
  entityId      String
  oldValue      String?   @db.Text
  newValue      String?   @db.Text
  userId        String?
  userName      String?
  createdAt     DateTime  @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

// Milestones (grandes tâches de projet)
model Milestone {
  id            String    @id @default(cuid())
  title         String
  description   String?   @db.Text
  status        String    @default("pending") // pending, in_progress, completed
  dueDate       DateTime?
  completedAt   DateTime?
  order         Int       @default(0)
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
}

// Notes et commentaires
model Note {
  id            String    @id @default(cuid())
  content       String    @db.Text
  entityType    String    // contact, company, project, opportunity
  entityId      String
  authorName    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([entityType, entityId])
}

// Témoignages clients
model Testimonial {
  id            String    @id @default(cuid())
  clientName    String
  contactName   String?
  companyName   String?
  status        String    @default("received") // received, requested, online, pending
  textFr        String?   @db.Text
  textEn        String?   @db.Text
  titleFr       String?
  titleEn       String?
  rating        Int?      @default(5)
  featured      Boolean   @default(false)
  companyId     String?
  contactId     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([featured])
}


// Phases de projet pour la transformation numérique
model ProjectPhase {
  id              String    @id @default(cuid())
  projectId       String
  phaseTemplateId String    // diagnostic, strategie, design, developpement, ia, formation, deploiement, suivi
  name            String
  description     String?
  status          String    @default("pending") // pending, in_progress, completed, skipped
  progress        Int       @default(0) // 0-100
  order           Int       @default(0)
  startDate       DateTime?
  endDate         DateTime?
  estimatedHours  Int?
  actualHours     Int?
  hourlyRate      Float?    @default(150)
  notes           String?   @db.Text
  deliverables    String?   @db.Text // JSON array of deliverables
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
}

// Devis générés
model Quote {
  id              String    @id @default(cuid())
  projectId       String?
  clientName      String
  clientEmail     String?
  clientCompany   String?
  title           String
  description     String?   @db.Text
  status          String    @default("draft") // draft, sent, accepted, rejected, expired
  validUntil      DateTime?
  subtotal        Float     @default(0)
  taxRate         Float     @default(0.15) // 15% TPS+TVQ
  taxAmount       Float     @default(0)
  total           Float     @default(0)
  currency        String    @default("CAD")
  phases          String?   @db.Text // JSON array of selected phases with pricing
  notes           String?   @db.Text
  terms           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
}


// Entrées de temps pour le time tracking
model TimeEntry {
  id          String    @id @default(cuid())
  employeeId  String
  taskId      String?
  projectId   String?
  description String?
  startTime   DateTime
  endTime     DateTime?
  duration    Int?      // Durée en minutes
  billable    Boolean   @default(true)
  status      String    @default("running") // running, completed, paused
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([employeeId])
  @@index([taskId])
  @@index([projectId])
  @@index([startTime])
}


// ============================================
// HUB COMMUNICATION NUMÉRIQUE
// ============================================

// Client de communication (lié à un projet existant ou standalone)
model CommunicationClient {
  id              String    @id @default(cuid())
  name            String
  company         String?
  email           String?
  phone           String?
  website         String?
  logoUrl         String?
  industry        String?
  description     String?   @db.Text
  status          String    @default("active") // active, paused, completed
  projectId       String?   // Lien optionnel vers un projet existant
  startDate       DateTime?
  monthlyBudget   Int?      // Budget mensuel en dollars
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  socialAccounts  SocialMediaAccount[]
  newsletters     Newsletter[]
  campaigns       Campaign[]
  accesses        ClientAccess[]
  messages        ClientMessage[]
  tasks           ClientTask[]

  @@index([status])
  @@index([projectId])
}

// Comptes de médias sociaux
model SocialMediaAccount {
  id              String    @id @default(cuid())
  clientId        String
  platform        String    // facebook, instagram, linkedin, twitter, tiktok, youtube, etc.
  accountName     String
  accountUrl      String?
  username        String?
  followers       Int?
  status          String    @default("active") // active, paused, archived
  accessEmail     String?
  accessPassword  String?   // Encrypted in production
  notes           String?   @db.Text
  lastPostDate    DateTime?
  postsPerWeek    Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  client          CommunicationClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([platform])
}

// Infolettres
model Newsletter {
  id              String    @id @default(cuid())
  clientId        String
  name            String
  platform        String?   // mailchimp, sendinblue, hubspot, etc.
  listSize        Int?      // Nombre d'abonnés
  frequency       String?   // weekly, biweekly, monthly
  lastSentDate    DateTime?
  nextSendDate    DateTime?
  openRate        Float?    // Taux d'ouverture moyen
  clickRate       Float?    // Taux de clic moyen
  status          String    @default("active")
  templateUrl     String?
  accessEmail     String?
  accessPassword  String?
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  client          CommunicationClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

// Campagnes numériques (pub, SEO, etc.)
model Campaign {
  id              String    @id @default(cuid())
  clientId        String
  name            String
  type            String    // google_ads, facebook_ads, linkedin_ads, seo, email, influencer
  status          String    @default("draft") // draft, active, paused, completed
  startDate       DateTime?
  endDate         DateTime?
  budget          Int?
  spent           Int?
  impressions     Int?
  clicks          Int?
  conversions     Int?
  revenue         Int?
  targetAudience  String?   @db.Text
  objectives      String?   @db.Text
  notes           String?   @db.Text
  platformUrl     String?   // Lien vers la plateforme de gestion
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  client          CommunicationClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
  @@index([status])
}

// Accès et liens clients (sites, outils, etc.)
model ClientAccess {
  id              String    @id @default(cuid())
  clientId        String
  name            String    // Nom du service/outil
  type            String    // website, hosting, domain, analytics, cms, crm, email, other
  url             String?
  username        String?
  password        String?   // Encrypted in production
  email           String?
  apiKey          String?
  expiryDate      DateTime?
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  client          CommunicationClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
}

// Messages/Communications avec le client
model ClientMessage {
  id              String    @id @default(cuid())
  clientId        String
  direction       String    // inbound, outbound
  channel         String    // email, phone, meeting, slack, other
  subject         String?
  content         String    @db.Text
  attachments     String?   @db.Text // JSON array of attachment URLs
  sentAt          DateTime  @default(now())
  sentBy          String?   // Employee ID or name
  isImportant     Boolean   @default(false)
  followUpDate    DateTime?
  status          String    @default("sent") // sent, read, replied, archived
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  client          CommunicationClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([sentAt])
}

// Tâches spécifiques au client
model ClientTask {
  id              String    @id @default(cuid())
  clientId        String
  title           String
  description     String?   @db.Text
  type            String?   // content, design, development, meeting, review, other
  status          String    @default("todo") // todo, in_progress, review, done
  priority        String    @default("medium") // low, medium, high, urgent
  dueDate         DateTime?
  assignedTo      String?   // Employee ID
  estimatedHours  Int?
  actualHours     Int?
  completedAt     DateTime?
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  client          CommunicationClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([dueDate])
}


// ==================== ONBOARDING ====================

model OnboardingStep {
  id          Int      @id @default(autoincrement())
  title       String
  description String   @db.Text
  content     String   @db.Text
  type        String   @default("info") // info, video, quiz, policy, tour
  order       Int
  role        String?  // null = all roles, or specific role (Lab, Bureau, Studio, Admin)
  isRequired  Boolean  @default(true)
  duration    Int      @default(5) // estimated minutes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  progress    OnboardingProgress[]
}

model Policy {
  id          Int      @id @default(autoincrement())
  title       String
  content     String   @db.Text
  category    String   // general, security, hr, conduct, remote
  version     String   @default("1.0")
  isActive    Boolean  @default(true)
  requiresAck Boolean  @default(true) // requires acknowledgment
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  acknowledgments PolicyAcknowledgment[]
}

model PolicyAcknowledgment {
  id         Int      @id @default(autoincrement())
  employeeId String
  policyId   Int
  acknowledgedAt DateTime @default(now())
  ipAddress  String?
  
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  policy     Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, policyId])
}

model OnboardingProgress {
  id          Int      @id @default(autoincrement())
  employeeId  String
  stepId      Int
  status      String   @default("pending") // pending, in_progress, completed, skipped
  completedAt DateTime?
  score       Int?     // for quiz steps
  
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  step        OnboardingStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, stepId])
}

// Chat AI conversation history
model ChatMessage {
  id         Int      @id @default(autoincrement())
  employeeId String
  role       String   // user, assistant
  content    String   @db.Text
  createdAt  DateTime @default(now())
  
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@index([employeeId])
}
